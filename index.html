<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seminar Check-in</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; text-align: center; }
        .container { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 2px solid #ddd; }
        
        #result-box { 
            display: none; 
            margin-top: 20px; 
            padding: 25px; 
            border-radius: 15px; 
            background-color: #e7f3ff; 
            border: 2px solid #3182ce;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .info-label { font-size: 14px; color: #3182ce; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .display-text { font-size: 22px; font-weight: bold; color: #2d3748; margin-top: 10px; line-height: 1.4; }
        
        #history-section { margin-top: 30px; text-align: left; border-top: 1px solid #eee; padding-top: 20px; }
        .history-item { font-size: 14px; padding: 8px; border-bottom: 1px solid #f7fafc; color: #718096; }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #2d3748; margin-top: 0;">Seminar Scanner</h2>
    
    <div id="reader"></div>

    <div id="result-box">
        <div class="info-label">✅ Participant Found</div>
        <div id="display-full" class="display-text"></div>
    </div>

    <div id="history-section">
        <strong style="color: #4a5568;">Recent History</strong>
        <div id="history-list"></div>
    </div>
</div>

<script>
    let participants = [];

    // Load your JSON file
    fetch('participants.json')
        .then(response => response.json())
        .then(data => { participants = data; })
        .catch(err => alert("Error: Ensure participants.json is in the same folder on GitHub."));

    function onScanSuccess(decodedText) {
        // Clean the scanned text (remove asterisks if they exist in the QR)
        const cleanID = decodedText.replace(/\*/g, "");

        // Find person by matching ID or Barcode field
        const person = participants.find(p => 
            p.ID.toString() === cleanID || 
            p.Barcode.replace(/\*/g, "") === cleanID
        );

        if (person) {
            const resultBox = document.getElementById('result-box');
            const displayDiv = document.getElementById('display-full');
            
            // Format: "1 | Yung Ting Kit | 先生 HKPC"
            // We take the Combined string and add the Organization (__1)
            const fullName = `${person["Combined (A+B+C)"]} ${person["__1"]}`;
            
            resultBox.style.display = 'block';
            displayDiv.innerText = fullName;

            addToHistory(fullName);

            if (navigator.vibrate) navigator.vibrate(100);
        }
    }

    function addToHistory(text) {
        const list = document.getElementById('history-list');
        const item = document.createElement('div');
        item.className = 'history-item';
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        item.innerHTML = `<strong>${time}</strong> - ${text}`;
        list.prepend(item); // Add to top
        if (list.children.length > 5) list.lastChild.remove();
    }

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
</script>

</body>
</html>